// For format details, see https://aka.ms/devcontainer.json. For config options, see the
// README at: https://github.com/devcontainers/templates/tree/main/src/javascript-node
{
	"name": "Talk-To-My-Lawyer Dev",
	// Or use a Dockerfile or Docker Compose file. More info: https://containers.dev/guide/dockerfile
	"image": "mcr.microsoft.com/devcontainers/base:bookworm",

	// Performance: Allocate more memory and CPU
	"runArgs": [
		"--memory=8g",
		"--cpus=4"
	],

	// Persist data across container rebuilds
	"mounts": [
		"source=${localWorkspaceFolderBasename}-node_modules,target=${containerWorkspaceFolder}/node_modules,type=volume"
	],

	// Performance: Exclude heavy directories from file watching
	"settings": {
		"files.watcherExclude": {
			"**/node_modules/**": true,
			"**/.git/objects/**": true,
			"**/.git/subtree-cache/**": true,
			"**/.next/**": true,
			"**/out/**": true,
			"**/dist/**": true
		},
		"search.exclude": {
			"**/node_modules": true,
			"**/bower_components": true,
			"**/*.code-search": true,
			"**/.git": true,
			"**/.next": true,
			"**/out": true,
			"**/dist": true
		},
		"files.exclude": {
			"**/.git": true,
			"**/.svn": true,
			"**/.hg": true,
			"**/CVS": true
		}
	},

	"features": {
		// Git and GitHub CLI
		"ghcr.io/devcontainers/features/git:1": {
			"version": "latest"
		},
		"ghcr.io/devcontainers/features/git-lfs:1": {
			"version": "latest"
		},
		"ghcr.io/devcontainers/features/github-cli:1": {
			"version": "latest"
		},
		// Node.js with pnpm (single source)
		"ghcr.io/devcontainers/features/node:1": {
			"version": "22",
			"pnpmVersion": "latest"
		},
		// Editor
		"ghcr.io/jungaretti/features/vim:1": {},
		// Database
		"ghcr.io/itsmechlark/features/postgresql:1": {
			"version": "latest"
		},
		// CLI tools for this project
		"ghcr.io/devcontainers-extra/features/supabase-cli:1": {
			"version": "latest"
		},
		"ghcr.io/devcontainers-extra/features/vercel-cli:1": {
			"version": "latest"
		}
	},

	// Forward the Next.js dev server port
	"forwardPorts": [3000],

	// Install dependencies after container is created
	"postCreateCommand": "sudo rm -rf node_modules/.bin 2>/dev/null; pnpm install",

	// VS Code extensions for this project
	"customizations": {
		"vscode": {
			"extensions": [
				"dbaeumer.vscode-eslint",
				"esbenp.prettier-vscode",
				"bradlc.vscode-tailwindcss"
			],
			// Performance: VS Code specific settings
			"settings": {
				// TypeScript performance - reduce memory
				"typescript.tsserver.experimental.enableProjectDiagnostics": false,
				"typescript.tsserver.maxTsServerMemory": 2048,
				"typescript.tsserver.watchOptions": {
					"watchDirectory": "useFsEvents",
					"watchFile": "useFsEvents"
				},
				"typescript.disableAutomaticTypeAcquisition": true,
				"typescript.surveys.enabled": false,
				
				// ESLint performance - run on save only
				"eslint.run": "onSave",
				"eslint.packageManager": "pnpm",
				"eslint.validate": [
					"javascript",
					"javascriptreact",
					"typescript",
					"typescriptreact"
				],
				
				// General performance - disable heavy features
				"editor.semanticTokenColorCustomizations": {
					"enabled": false
				},
				"editor.tokenColorCustomizations": {
					"enabled": false
				},
				"editor.codeLens": false,
				"editor.minimap.enabled": false,
				"editor.renderWhitespace": "none",
				"editor.bracketPairColorization.enabled": false,
				"editor.guides.indentation": false,
				"editor.hover.delay": 1000,
				"editor.quickSuggestions": {
					"other": false,
					"comments": false,
					"strings": false
				},
				
				// Git performance
				"git.enableSmartCommit": true,
				"git.autofetch": false,
				"git.decorations.enabled": false,
				"git.blame.enabled": false,
				
				// Extension performance
				"extensions.autoUpdate": false,
				"extensions.autoCheckUpdates": false,
				"workbench.startupEditor": "none",
				
				// Tailwind performance - exclude large dirs
				"tailwindCSS.includeLanguages": {
					"typescript": "javascript",
					"typescriptreact": "javascriptreact"
				},
				"tailwindCSS.files.exclude": [
					"**/.git/**",
					"**/node_modules/**",
					"**/.hg/**",
					"**/.svn/**",
					"**/.next/**"
				],
				
				// Disable telemetry and updates
				"telemetry.telemetryLevel": "off",
				"update.mode": "none",
				
				// File watching - critical for memory
				"files.watcherExclude": {
					"**/node_modules/**": true,
					"**/.git/objects/**": true,
					"**/.git/subtree-cache/**": true,
					"**/.next/**": true,
					"**/out/**": true,
					"**/dist/**": true,
					"**/.pnpm/**": true
				}
			}
		}
	}
}
